<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Firebase Auth Example</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>ログイン/登録</h1>
    <input type="email" id="email" placeholder="メールアドレス" />
    <input type="password" id="password" placeholder="パスワード" />
    <button id="registerButton">新規登録</button>
    <button id="loginButton">ログイン</button>
    <button id="logoutButton" style="display: none">ログアウト</button>
    <button id="resendEmailButton" style="display: none">
      確認メールを再送信
    </button>

    <p id="statusMessage"></p>
    <p id="loggedInUser"></p>

    <script type="module">
      // FirebaseのモジュールSDKをインポート
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
        sendEmailVerification,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

      // Firebase設定
      const firebaseConfig = {
        apiKey: "AIzaSyDeTc3FlVDJ5CGfFalpPaa4KsINZY06_Qk",
        authDomain: "tk-mlfy.firebaseapp.com",
        projectId: "tk-mlfy",
        storageBucket: "tk-mlfy.firebasestorage.app",
        messagingSenderId: "126641075074",
        appId: "1:126641075074:web:cfa68d7abd82d8d368559b",
        measurementId: "G-9NFPMH21E4",
      };

      // Firebaseを初期化
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // HTML要素を取得
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const registerButton = document.getElementById("registerButton");
      const loginButton = document.getElementById("loginButton");
      const logoutButton = document.getElementById("logoutButton");
      const loggedInUserDisplay = document.getElementById("loggedInUser");
      const statusMessage = document.getElementById("statusMessage");
      const resendEmailButton = document.getElementById("resendEmailButton");

      // 画面遷移先のURLを定義
      const targetUrl = "https://www.google.com/";

      // 新規登録ボタンのイベントリスナー
      registerButton.addEventListener("click", async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
          statusMessage.textContent =
            "メールアドレスとパスワードを両方入力してください。";
          return;
        }
        try {
          statusMessage.textContent = "登録中...";
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;

          const actionCodeSettings = {
            url: window.location.href,
            handleCodeInApp: true,
          };
          await sendEmailVerification(user, actionCodeSettings);

          await setDoc(doc(db, "users", user.uid), {
            email: user.email,
            createdAt: new Date(),
          });
          statusMessage.textContent =
            "登録が完了しました。確認メールを送信しましたので、メール内のリンクをクリックして認証を完了してください。";
        } catch (error) {
          statusMessage.textContent = `エラー: ${error.message}`;
        }
      });

      // ログインボタンのイベントリスナー
      loginButton.addEventListener("click", async () => {
        const email = emailInput.value;
        const password = passwordInput.value;

        if (!email || !password) {
          statusMessage.textContent =
            "メールアドレスとパスワードを両方入力してください。";
          return;
        }

        try {
          statusMessage.textContent = "ログイン中...";
          await signInWithEmailAndPassword(auth, email, password);
          // ログイン成功後は onAuthStateChanged が処理するため、ここでは何もしない
        } catch (error) {
          console.error("ログインエラー:", error);
          let errorMessage =
            "ログインに失敗しました。メールアドレスまたはパスワードが間違っています。";
          if (
            error.code === "auth/user-not-found" ||
            error.code === "auth/wrong-password"
          ) {
            errorMessage = "メールアドレスまたはパスワードが正しくありません。";
          } else if (error.code === "auth/invalid-email") {
            errorMessage = "無効なメールアドレス形式です。";
          } else if (error.code === "auth/too-many-requests") {
            errorMessage =
              "ログイン試行回数が多すぎます。しばらくしてからお試しください。";
          }
          statusMessage.textContent = errorMessage;
        }
      });

      // ログアウトボタンのイベントリスナー
      logoutButton.addEventListener("click", async () => {
        try {
          await signOut(auth);
          statusMessage.textContent = "ログアウトしました。";
        } catch (error) {
          statusMessage.textContent = `ログアウトエラー: ${error.message}`;
        }
      });

      // 認証状態の変更を監視し、画面遷移を制御するメインロジック
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // ユーザーがログインしている
          loggedInUserDisplay.textContent = `ログイン中のユーザー: ${user.email}`;
          loginButton.style.display = "none";
          registerButton.style.display = "none";
          emailInput.style.display = "none";
          passwordInput.style.display = "none";
          logoutButton.style.display = "block";
          resendEmailButton.style.display = "none";

          // 最新の認証状態を強制的に取得
          await user.reload();

          if (user.emailVerified) {
            // メールアドレスが認証済みの場合
            statusMessage.textContent = "ログインが成功しました。";

            // 既に遷移先にいる場合は何もしない
            if (window.location.href !== targetUrl) {
              console.log("メールアドレスが認証済みです。画面遷移します。");
              window.location.href = targetUrl;
            } else {
              console.log(
                "メールアドレスが認証済みですが、すでに遷移先にいます。"
              );
            }
          } else {
            // メールアドレスが未認証の場合
            statusMessage.textContent =
              "メールアドレスが認証されていません。送信された確認メールを確認してください。";
            resendEmailButton.style.display = "block";
          }
        } else {
          // ユーザーがログアウトしている
          loggedInUserDisplay.textContent = "";
          loginButton.style.display = "block";
          registerButton.style.display = "block";
          emailInput.style.display = "block";
          passwordInput.style.display = "block";
          logoutButton.style.display = "none";
          resendEmailButton.style.display = "none";
          statusMessage.textContent = "ログインまたは新規登録してください。";
        }
      });
    </script>
  </body>
</html>
